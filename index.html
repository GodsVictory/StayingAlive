<html style="overflow:hidden;">

<head>
  <title>StayingAlive</title>
  <link rel="shortcut icon" href="favicon.ico" />
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no' name='viewport' />
  <meta name="viewport" content="width=device-width" />
  <link href='https://fonts.googleapis.com/css?family=Fredoka+One' rel='stylesheet' type='text/css'>
  <script src="tmi.js"></script>
  <script src="velocity.js"></script>
  <script src="qurl.js"></script>
  <script src="jquery-3.1.1.slim.min.js"></script>
  <script>
    var channel = "";
    var cheerers = new Array();
    var clientOptions = {
        options: {
          debug: false
        },
        connection: {
          reconnect: true,
          secure: true
        },
      },
      client = new tmi.client(clientOptions);
    
    loop();
    function loop () {
      setTimeout(function() {
        for (key in cheerers)
          if (cheerers[key].bits >= 0) {
            var digits = cheerers[key].total.toString().length;
            var subtractFrom = "1";
            while (subtractFrom.length < digits) subtractFrom = "0" + subtractFrom;
            subtractFrom = parseFloat("."+subtractFrom);
            
            var bits = cheerers[key].total;
            for (i=0;i<digits;i++)
              bits = "0" + bits;
            bits = parseFloat("."+bits);
            
            cheerers[key].bits -= (subtractFrom-bits)*100;
            $("#"+key).width(cheerers[key].bits/cheerers[key].total*100+"%")
            $("#health"+key).text(Math.floor(cheerers[key].bits));
          } else {
            delete cheerers[key];
            $("#"+key).parent().remove();
          }
        loop();
      }, 10);
    }
    
    client.on('cheer', cheer);
    function cheer(channel, userstate, message) {
      if (cheerers[userstate["display-name"]] === undefined) {
        cheerers[userstate["display-name"]] = { bits:parseInt(userstate.bits), total:parseInt(userstate.bits) };
        $("#health").append('<div style="width:100%;height:34px;background-color:SlateGrey;position:relative;margin-bottom:10px;"><div id="'+userstate["display-name"]+'" style="width:100%;left:0px;background-color:lime;position:absolute;font:20px Fredoka One;padding:5px 0 5px 0px;color:Black;">&nbsp;'+userstate["display-name"]+'</div><div id="health'+userstate["display-name"]+'" style="position:absolute;width:100%;text-align:center;font:20px Fredoka One;padding:5px 0 5px 0;color:Black;z-index:2;top:0px;">'+userstate.bits+'</div></div>');
      } else {
        cheerers[userstate["display-name"]].bits += userstate.bits;
        cheerers[userstate["display-name"]].total += userstate.bits;
      }
    };

    client.on('connected', function () {
      document.getElementById('channel').placeholder = "Channel..."
      document.getElementById('channel').readOnly = false;
      setChannel(Qurl.create().query('c'));
    });

    client.connect();
    var blackout;
    
    function setChannel(channel) {
      clearTimeout(blackout);
      if (channel) {
        this.channel = channel;
        document.getElementById("channel").value = channel;
        Qurl.create().query('c', channel);
        client.join(channel).catch(function (err) {});
      } else
        Qurl.create().query('c', false);
      blackout = setTimeout(function () {
        document.getElementById("channel").style.textShadow = "0 0 0 transparent";
      }, 3000);
      
      if (channel == "test") {
        setInterval(function() {
          var teststate = {};
          teststate.bits = 59;
          teststate["display-name"] = "qwer";
          cheer("qwer",teststate,"qwer")
        }, 1100);    
        setInterval(function() {
          var teststate = {};
          teststate.bits = 100;
          teststate["display-name"] = "zxcv";
          cheer("qwer",teststate,"qwer")
        }, 1100);
      setTimeout(function() {
        var teststate = {};
        teststate.bits = 1000;
        teststate["display-name"] = "asdf";
        cheer("asdf",teststate,"asdf")
      }, 1000);
      setTimeout(function() {
        var teststate = {};
        teststate.bits = 10000;
        teststate["display-name"] = "bvn";
        cheer("asdf",teststate,"asdf")
      }, 1000);
      }
    }

    function channelUpdate() {
      var channelInput = document.getElementById("channel");
      channelInput.style.textShadow = "0 0 0 white";
      if (channel.length > 0)
        client.part(channel);
      setChannel(channelInput.value);
    }

    var cursorTimeout;
    document.addEventListener("mousemove", function () {
      document.body.style.cursor = "auto";
      clearTimeout(cursorTimeout);
      cursorTimeout = setTimeout(function () {
        document.body.style.cursor = "none";
      }, 1000);
    });
  </script>
</head>

<body style="margin:0;padding:0;background-color:black;width:100%;height:100%;overflow:hidden;position:relative;-webkit-backface-visibility:hidden;backface-visibility:hidden;">
  <input type="text" id="channel" readonly="readonly" onblur="this.focus()" onkeyup="channelUpdate()" autofocus style='padding-left:5px;background-color:transparent;outline:none;color:transparent;text-shadow:0 0 0 white;border:none;position:absolute;width:100%;font-size:24px;font-family:"Fredoka One";top:0px;' name="channel" placeholder='Connecting...'>
  <div id="health" style="height:100%;width:90%;padding:35px 5% 0 5%;"></div>
</body>

</html>